default_platform(:ios)

platform :ios do
  def common_build_actions
    sh "cd .. && cd .. && ls -a"
    sh "cd .. && ls -a"
    sh "cd .. && gem install cocoapods"
    sh "cd .. && rm Podfile.lock && ls -a"
    sh "flutter clean"
    sh "flutter pub get"
    sh "flutter pub cache repair"
    update_code_signing_settings(
      use_automatic_signing: false,
    )
    create_keychain(
      name: ENV['TEMP_KEYCHAIN_USER'],
      password: ENV['TEMP_KEYCHAIN_PASSWORD'],
      timeout: 1800
    )

    build_app(
      scheme: "Runner",
      workspace: "Runner.xcworkspace",
      export_method: "app-store",
      export_options: {
        "tree_shake_icons": false,
        provisioningProfiles: {
            "com.heyflutter.asanYab" => "match AppStore com.heyflutter.asanYab"
          }
      }
    )
  end

  def generate_api_key
    app_store_connect_api_key(
      key_id: "FLUCGL7SRZ",
      issuer_id: "7ca7cab7-f3fd-4fb6-a1ed-5fe1a20c2db0",
      key_filepath: "./AuthKey_FLUCGL7SRZ.p8", #"/Users/harisatiq/Downloads/AuthKey_FLUCGL7SRZ.p8",
      duration: 1200, # optional (maximum 1200)
      in_house: false # optional but may be required if using match/sigh
    )
  end

  lane :deployToTestFlight do
    ENV['FASTLANE_SESSION']='---\n- !ruby/object:HTTP::Cookie\n  name: myacinfo\n  value: DAWTKNV323952cf8084a204fb20ab2508441a07d02d37f6536d0fcd68b98ef549fc6291cfd834bdaafb49d96f7b7296413984a997dc8e3f73d9bd551e3d33e5baf78745da009d8e467722743dc088fcf8a1850d60c4311c810194c5629522e9373a8c401ce9d9bd266218a314e3a9ecc047bf4ed0fa5dd2ca240ec969dac8b7bcf2e10b824d9a99b0149da0ec1f144fcfe476018694984f1c3df24d27fc1cb9e4bd0dbf046bd80c4eb8fd2cd4b8dba9fc94fe961942e0ccc28e7e18addbe5edadaa2dd25fd74eaa659d0000b5b697b22a42bfe9a991783a64e04b8ab887f6aab1657f43d5cf10858e5b77c0ddc4b7bfd493e33b5633fc55da296f4ce53988943384856796b99a1130b07bd2a37b129e97160df717acf5dec21e812013135916013fc972d2979be7111f1112c1772d3bc3024161759f35a358228eef5d7641d44b061324535e12f15ec2239844fb7be237624b39d45e436f9218d0bbe1a3297827794e666e86b21cc8e05deef501910ea722415e7595e9746896c6df11c385882fae1cd2e6d6736fb844818c601876b78e8bb9119317df42bbebdd5c40b2b4a81c2a0d25548bcb3d41803d089602dbbc3bc2a95db2755adb2374252b5730ba1cb1f346b6bdc9466182640120a344169163acf69369bc604826d26b229e32856020a7d0c7993e1bb868ea507430935c7afa0720ce01ecd24096f6ba5ad71dcc67fc81b36b49a8682401b19d219dbcb959cac21f9c1ce89585a47V3\n  domain: apple.com\n  for_domain: true\n  path: "/"\n  secure: true\n  httponly: true\n  expires:\n  max_age:\n  created_at: 2023-10-03 15:17:51.702007000 +05:00\n  accessed_at: 2023-10-03 15:17:51.703533000 +05:00\n- !ruby/object:HTTP::Cookie\n  name: DES54f4569f652c4e652e4350a154ed2ed6f\n  value: HSARMTKNSRVXWFlattMHRVOBq7WjU83yVGNit0/Q9G/jRuBEtPpwEUY2tGT/2WT9/n1agL7U1n/rjXZ4qYW4N/mxezYbpdzrULMjnLABOEpv7K9Hj5mQpCICa43hczP1w2QW8inq931qIGNp4AVIFszDq1EF0OiUM69f1FiA3B3vB4wekPRikqnhi/xR6zZEtolsPIUQALTHZGLtFtwxV0Ye6pSSmGQ+x4o3m94+iCM=SRVX\n  domain: idmsa.apple.com\n  for_domain: true\n  path: "/"\n  secure: true\n  httponly: true\n  expires:\n  max_age: 2592000\n  created_at: 2023-09-28 19:32:32.682038000 +05:00\n  accessed_at: 2023-10-03 15:17:49.988650000 +05:00\n- !ruby/object:HTTP::Cookie\n  name: dqsid\n  value: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2OTYzMjgyNzIsImp0aSI6InhSOEtWaEpDdXdTOVRpYVRyU0dqN1EifQ.lXLUoXfVhPwp8a2Gzw_RsHgTdgtPabJrO1u6X3S_2FU\n  domain: appstoreconnect.apple.com\n  for_domain: false\n  path: "/"\n  secure: true\n  httponly: true\n  expires:\n  max_age: 1800\n  created_at: &1 2023-10-03 15:17:53.291480000 +05:00\n  accessed_at: *1\n'
    sh "fastlane match appstore -a com.heyflutter.asanYab"
    common_build_actions
    api_key = generate_api_key
    upload_to_testflight(api_key: api_key,)
  end

  lane :deployToAppStore do
    common_build_actions
    api_key = generate_api_key
    upload_to_app_store(
      api_key: api_key,
      force: true,
      run_precheck_before_submit: false
    )
  end
end
