default_platform(:ios)

platform :ios do
  def common_build_actions
    # sh "git clone git@github.com:HarisAtiq2762/ios-certificates.git"
    # sh "fastlane match appstore -a com.heyflutter.asanYab"
    # match(type: "appstore", readonly: true)
    # sh "flutter clean"
    sh "cd .. && cd .. && ls -a"
    sh "cd .. && ls -a"
    # sh "echo again"
    # sh "cd .. && ls -a"
    # sh "flutter pub get"
    # sh "ls -a"
    # sh "cd ios"
    # sh "ls -a"
    sh "cd .. && gem install cocoapods"
    # sh "pod deintegrate"
    # sh "pod clean"
    # sh "cd . && ls -a"
    # && rm Podfile
    sh "cd .. && rm Podfile.lock && ls -a"
    # sh "rm Podfile"
    # sh "rm Podfile.lock"
    # sh "ls -a"
    sh "flutter clean"
    sh "flutter pub get"
    # sh "cd .. && rm -rf Pods && pod install --repo-update"

    # sh "pod install"
    # sh "gem update cocoapods --pre"
    # sh "pod install --repo-update"
    update_code_signing_settings(
      use_automatic_signing: false,
    )
    # enable_automatic_code_signing()
    create_keychain(
      name: ENV['TEMP_KEYCHAIN_USER'],
      password: ENV['TEMP_KEYCHAIN_PASSWORD'],
      timeout: 1800
    )
#     sh "flutter clean"
#     sh "flutter pub get"
#       sh "pod deintegrate"
#       sh "pod update"
#       sh "pod install"
#     sh "gem update cocoapods --pre"
#     sh "pod update"
#     version_codes = app_store_build_number(
#       live: false,
#       app_identifier: "com.heyflutter.asanYab",
#       username: "dev.milkejohannes@gmail.com"
#     )
#     new_version_code = version_codes + 1
#     puts "Determined new version code is #{new_version_code}"
#     sh "pwd"
#     sh "ls"
#     sh "pwd && fvm flutter build ipa --build-number #{new_version_code} --no-tree-shake-icons --verbose"
# flutter build ipa --release --no-tree-shake-icons
    # gym(
    #   configuration: "Release",
    #   workspace: "Runner.xcworkspace",
    #   scheme: "Runner",
    #   export_method: "app-store",
    #   # export_xcargs: "-allowProvisioningUpdates",
    #   export_options: {
    #   "tree_shake_icons": false,
    #   signingStyle: "automatic",
    #   }
    # )
    build_app(
      scheme: "Runner",
      workspace: "Runner.xcworkspace",
      export_method: "app-store",
      # export_xcargs: "-allowProvisioningUpdates",
      export_options: {
        # signingStyle: "automatic",
        "tree_shake_icons": false,
        provisioningProfiles: {
            "com.heyflutter.asanYab" => "match AppStore com.heyflutter.asanYab"
          }
      }
    )
  end

  def generate_api_key
    app_store_connect_api_key(
      key_id: "FLUCGL7SRZ",
      issuer_id: "7ca7cab7-f3fd-4fb6-a1ed-5fe1a20c2db0",
      key_filepath: "./AuthKey_FLUCGL7SRZ.p8", #"/Users/harisatiq/Downloads/AuthKey_FLUCGL7SRZ.p8",
      duration: 1200, # optional (maximum 1200)
      in_house: false # optional but may be required if using match/sigh
    )
  end

  lane :deployToTestFlight do
    # export FASTLANE_SESSION=$FASTLANE_SESSION
    # export FASTLANE_SESSION="---\n- !ruby/object:HTTP::Cookie\n  name: myacinfo\n  value: DAWTKNV323952cf8084a204fb20ab2508441a07d02d3a91c648e55c5919a926d852ed9f2cc643b39cd480473412273dcc2651b9b6daef30aaf3a336184298312c53cd54bf014da7dbcae64265daa376df12fd0a9e4a41558eede941e54b7dbfa87c8b0ffc2435c754d11522c918484ccf78c4a76e96c86b6ef31c049b7c58f6a9fddd6977dbde085d39a5f9c58f7768a4ab41bea70fed87e792d570118a4b6c2d477f791c244b00274a4deaa3229508c119de5cee3ee33ed81e47f4a3a387f5a8fe4860db40e7b2e05c043fc6bc17894dc0bfa05337f71c97cdf7451fad4414069c8f167b2e3f3184df54fb480909d76765028798069ad26157b4b7b2dc041596166e9da111e54a8a0e34f9d31a9e6847ba6a1ebc27418ed8e463e3f7009fdee8c4c87b60562bd7776686cae04ac92c73d375d854de867dbf94d54c182473944ee77995fa331404b176fc19531b0e87445ec5777adf3305699b59fca21050089192db8afc0e36218275406d64362908ae31a607de9e2b9678fbafaa0ee4843c4a81665b4872bb4bfcf8b1b3cf81573f255123abfb9fc00d74b29ea36b33650b08b68c1318b991797cc2ff051b25a720e41a8ebe7ca6245dbafcac82985257a28955ed40439491c29ea0cdf1505ba376caad30496fdcaf0bb61c44b56f36e97abcfa2e779577f2a816c0715daa1e638428579d4bb9e0cd4825b97a505070b30f9f2443cf8d05b57be8c5c2ebc2acdaf5480899bdd881d585a47V3\n  domain: apple.com\n  for_domain: true\n  path: "/"\n  secure: true\n  httponly: true\n  expires:\n  max_age:\n  created_at: 2023-10-03 00:15:53.001257000 +05:00\n  accessed_at: 2023-10-03 02:31:23.038919000 +05:00\n- !ruby/object:HTTP::Cookie\n  name: DES54f4569f652c4e652e4350a154ed2ed6f\n  value: HSARMTKNSRVXWFlattMHRVOBq7WjU83yVGNit0/Q9G/jRuBEtPpwEUY2tGT/2WT9/n1agL7U1n/rjXZ4qYW4N/mxezYbpdzrULMjnLABOEpv7K9Hj5mQpCICa43hczP1w2QW8inq931qIGNp4AVIFszDq1EF0OiUM69f1FiA3B3vB4wekPRikqnhi/xR6zZEtolsPIUQALTHZGLtFtwxV0Ye6pSSmGQ+x4o3m94+iCM=SRVX\n  domain: idmsa.apple.com\n  for_domain: true\n  path: "/"\n  secure: true\n  httponly: true\n  expires:\n  max_age: 2592000\n  created_at: 2023-09-28 19:32:32.682038000 +05:00\n  accessed_at: 2023-10-03 00:15:51.539429000 +05:00\n- !ruby/object:HTTP::Cookie\n  name: dqsid\n  value: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2OTYyODIyODQsImp0aSI6ImJray0tMi1lZkltUnRCS1NTempHUWcifQ.4L6-hLc6RGrHiucbo2JuaaFw_AfNcw9DjcdfHU5kdnc\n  domain: appstoreconnect.apple.com\n  for_domain: false\n  path: "/"\n  secure: true\n  httponly: true\n  expires:\n  max_age: 1800\n  created_at: &1 2023-10-03 02:31:24.933581000 +05:00\n  accessed_at: *1\n"
    # export FASTLANE_SESSION=
    ENV['FASTLANE_SESSION']='---\n- !ruby/object:HTTP::Cookie\n  name: myacinfo\n  value: DAWTKNV323952cf8084a204fb20ab2508441a07d02d37f6536d0fcd68b98ef549fc6291cfd834bdaafb49d96f7b7296413984a997dc8e3f73d9bd551e3d33e5baf78745da009d8e467722743dc088fcf8a1850d60c4311c810194c5629522e9373a8c401ce9d9bd266218a314e3a9ecc047bf4ed0fa5dd2ca240ec969dac8b7bcf2e10b824d9a99b0149da0ec1f144fcfe476018694984f1c3df24d27fc1cb9e4bd0dbf046bd80c4eb8fd2cd4b8dba9fc94fe961942e0ccc28e7e18addbe5edadaa2dd25fd74eaa659d0000b5b697b22a42bfe9a991783a64e04b8ab887f6aab1657f43d5cf10858e5b77c0ddc4b7bfd493e33b5633fc55da296f4ce53988943384856796b99a1130b07bd2a37b129e97160df717acf5dec21e812013135916013fc972d2979be7111f1112c1772d3bc3024161759f35a358228eef5d7641d44b061324535e12f15ec2239844fb7be237624b39d45e436f9218d0bbe1a3297827794e666e86b21cc8e05deef501910ea722415e7595e9746896c6df11c385882fae1cd2e6d6736fb844818c601876b78e8bb9119317df42bbebdd5c40b2b4a81c2a0d25548bcb3d41803d089602dbbc3bc2a95db2755adb2374252b5730ba1cb1f346b6bdc9466182640120a344169163acf69369bc604826d26b229e32856020a7d0c7993e1bb868ea507430935c7afa0720ce01ecd24096f6ba5ad71dcc67fc81b36b49a8682401b19d219dbcb959cac21f9c1ce89585a47V3\n  domain: apple.com\n  for_domain: true\n  path: "/"\n  secure: true\n  httponly: true\n  expires:\n  max_age:\n  created_at: 2023-10-03 15:17:51.702007000 +05:00\n  accessed_at: 2023-10-03 15:17:51.703533000 +05:00\n- !ruby/object:HTTP::Cookie\n  name: DES54f4569f652c4e652e4350a154ed2ed6f\n  value: HSARMTKNSRVXWFlattMHRVOBq7WjU83yVGNit0/Q9G/jRuBEtPpwEUY2tGT/2WT9/n1agL7U1n/rjXZ4qYW4N/mxezYbpdzrULMjnLABOEpv7K9Hj5mQpCICa43hczP1w2QW8inq931qIGNp4AVIFszDq1EF0OiUM69f1FiA3B3vB4wekPRikqnhi/xR6zZEtolsPIUQALTHZGLtFtwxV0Ye6pSSmGQ+x4o3m94+iCM=SRVX\n  domain: idmsa.apple.com\n  for_domain: true\n  path: "/"\n  secure: true\n  httponly: true\n  expires:\n  max_age: 2592000\n  created_at: 2023-09-28 19:32:32.682038000 +05:00\n  accessed_at: 2023-10-03 15:17:49.988650000 +05:00\n- !ruby/object:HTTP::Cookie\n  name: dqsid\n  value: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2OTYzMjgyNzIsImp0aSI6InhSOEtWaEpDdXdTOVRpYVRyU0dqN1EifQ.lXLUoXfVhPwp8a2Gzw_RsHgTdgtPabJrO1u6X3S_2FU\n  domain: appstoreconnect.apple.com\n  for_domain: false\n  path: "/"\n  secure: true\n  httponly: true\n  expires:\n  max_age: 1800\n  created_at: &1 2023-10-03 15:17:53.291480000 +05:00\n  accessed_at: *1\n'
    sh "fastlane match appstore -a com.heyflutter.asanYab"
    common_build_actions
    api_key = generate_api_key
    upload_to_testflight(api_key: api_key,)
  end

  lane :deployToAppStore do
    common_build_actions
    api_key = generate_api_key
    upload_to_app_store(
      api_key: api_key,
      force: true,
      run_precheck_before_submit: false
    )
  end
end
