default_platform(:ios)

platform :ios do
  def common_build_actions

    setup_ci(force: true)

    sync_code_signing(  
      type: "appstore",
      readonly: is_ci
    )
    curr_build_number = app_store_build_number(
      live: false,
      app_identifier: "com.heyflutter.asanYab",
      username: "dev.milkejohannes@gmail.com"
    )

    increment_build_number(
      build_number: curr_build_number + 1,
    )

    build_app(
      scheme: "Runner",
      workspace: "Runner.xcworkspace",
      clean: false,
      export_method: "app-store",
      export_xcargs: "-allowProvisioningUpdates",
      export_options: {
        "tree_shake_icons": false,
        signingStyle: "automatic",
        # provisioningProfiles: {
        #     "com.heyflutter.asanYab" => "match AppStore com.heyflutter.asanYab"
        #   }
      }
    )
  end

  def generate_api_key
    app_store_connect_api_key(
      key_id: "FLUCGL7SRZ",
      issuer_id: "7ca7cab7-f3fd-4fb6-a1ed-5fe1a20c2db0",
      key_filepath: "./AuthKey_FLUCGL7SRZ.p8", #"/Users/harisatiq/Downloads/AuthKey_FLUCGL7SRZ.p8",
      duration: 1200, # optional (maximum 1200)
      in_house: false # optional but may be required if using match/sigh
    )
  end

  lane :deployToTestFlight do
    ENV['FASTLANE_SESSION']='---\n- !ruby/object:HTTP::Cookie\n  name: myacinfo\n  value: DAWTKNV323952cf8084a204fb20ab2508441a07d02d32d2094eaf776ca5483b2a2423b4b1f7f548ffea7b30635d1ff5211e39c7c1c84d31f2137dd6da6360a47fb7f3ed162e53fd7e733e7f998b23ce8c0db53f2d309760043c57dbc5ee4967664d79e2277a7e47720fe5c94b8cca391d807676a02f7b681a669e5823498f592d33bf124f604628cc07b216b245897c72bf221743a8f4249a6a022bbfdd1e54db1a15ab9327c3b4408456db17749c3d687c20a857f87b8e09662db81a185399b83ec2e71a03f6b0a19618dcbc2995edfc6b47323b1dad00919cd88abb1446964dac90207e2e250e3a9a8d75a536df524ed16f60c5a7f565d196eb734f5586f125a02bf13a2d31b5534c1347f02cf56cdde98361d002d21ad35fb977309b63b11ae03936f1e4c60bf9ee48aa45e42705e7b0f09d5fdbe5cda57609b0224af42b6c77a44442a13e54f02df67ced8a4c171cb00d0f67a4fd5c694c8ea25a0bf54a81055edb6826095905288607c558fcd9571db1bfda6a31dd1bbb0880fee0bbfc14683a465a1dda7a98c73943bff310ca4bc1f991c8e6642bd3a8d65c80e0b9cf32f5587d42c1662c328fd8c558400211fc9007df92ab5c6a3414c54bb3eb78af383b19b3994d89d547312b5caec3a36b31e911644c991b5950b466164ab56df6a8330afcd5b6d4854e371ceb17a655447b2149e8e3757ae7b3ea4288b67e36011f03d3dd9bbe64d5d0b312b3b0c0ae936f96608efb9a9585a47V3\n  domain: apple.com\n  for_domain: true\n  path: "/"\n  secure: true\n  httponly: true\n  expires:\n  max_age:\n  created_at: 2023-10-04 11:45:25.911287000 +05:00\n  accessed_at: 2023-10-04 11:45:25.912048000 +05:00\n- !ruby/object:HTTP::Cookie\n  name: DES54f4569f652c4e652e4350a154ed2ed6f\n  value: HSARMTKNSRVXWFlattMHRVOBq7WjU83yVGNit0/Q9G/jRuBEtPpwEUY2tGT/2WT9/n1agL7U1n/rjXZ4qYW4N/mxezYbpdzrULMjnLABOEpv7K9Hj5mQpCICa43hczP1w2QW8inq931qIGNp4AVIFszDq1EF0OiUM69f1FiA3B3vB4wekPRikqnhi/xR6zZEtolsPIUQALTHZGLtFtwxV0Ye6pSSmGQ+x4o3m94+iCM=SRVX\n  domain: idmsa.apple.com\n  for_domain: true\n  path: "/"\n  secure: true\n  httponly: true\n  expires:\n  max_age: 2592000\n  created_at: 2023-09-28 19:32:32.682038000 +05:00\n  accessed_at: 2023-10-04 11:45:24.383959000 +05:00\n- !ruby/object:HTTP::Cookie\n  name: dqsid\n  value: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2OTY0MDE5MjcsImp0aSI6IkhxanNjSl94cHhFZ2JYYXBzbUpzN0EifQ.On0vvet2iGZRDS1zMFl9mY4Y2C_qN5DHee7U0PVD_cs\n  domain: appstoreconnect.apple.com\n  for_domain: false\n  path: "/"\n  secure: true\n  httponly: true\n  expires:\n  max_age: 1800\n  created_at: &1 2023-10-04 11:45:28.754188000 +05:00\n  accessed_at: *1\n'
    sh "fastlane match appstore -a com.heyflutter.asanYab"
    common_build_actions
    api_key = generate_api_key
    upload_to_testflight(api_key: api_key,)
  end

  lane :deployToAppStore do
    common_build_actions
    api_key = generate_api_key
    upload_to_app_store(
      api_key: api_key,
      force: true,
      run_precheck_before_submit: false
    )
  end
end
