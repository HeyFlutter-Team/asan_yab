default_platform(:ios)

platform :ios do
  def common_build_actions
    # sh "cd .. && cd .. && ls -a"
    # sh "cd .. && ls -a"
    # sh "cd .. && gem install cocoapods"
    # sh "cd .. && rm Podfile.lock && ls -a"
    # sh "flutter clean"
    # sh "flutter pub cache repair"
    # sh "flutter pub cache clean"
    # sh "flutter pub get"
    # sh "gem install cocoapods"
    # sh "cd .. && pod install"
    # sh "flutter pub cache repair"
    # update_code_signing_settings(
    #   use_automatic_signing: true,
    # )
    # create_keychain(
    #   name: ENV['TEMP_KEYCHAIN_USER'],
    #   password: ENV['TEMP_KEYCHAIN_PASSWORD'],
    #   timeout: 1800
    # )

    # sh "find Users"
    # sh "find runner"
    # sh "find work"
    # sh "ls"

    # cocoapods(
    #   clean_install: true,
    #   podfile: "./Podfile"
    # )

    setup_ci(force: true)

    sync_code_signing(  
      type: "appstore",
      readonly: is_ci
    )
    curr_build_number = app_store_build_number(
      live: false,
      app_identifier: "com.heyflutter.asanYab",
      username: "dev.milkejohannes@gmail.com"
    )
    sh "echo ${curr_build_number}"

    increment_build_number(
      build_number: curr_build_number + 1,
    )

    build_app(
      scheme: "Runner",
      workspace: "Runner.xcworkspace",
      clean: false,
      export_method: "app-store",
      export_xcargs: "-allowProvisioningUpdates",
      export_options: {
        "tree_shake_icons": false,
        signingStyle: "automatic",
        provisioningProfiles: {
            "com.heyflutter.asanYab" => "match AppStore com.heyflutter.asanYab"
          }
      }
    )
  end

  def generate_api_key
    app_store_connect_api_key(
      key_id: "FLUCGL7SRZ",
      issuer_id: "7ca7cab7-f3fd-4fb6-a1ed-5fe1a20c2db0",
      key_filepath: "./AuthKey_FLUCGL7SRZ.p8", #"/Users/harisatiq/Downloads/AuthKey_FLUCGL7SRZ.p8",
      duration: 1200, # optional (maximum 1200)
      in_house: false # optional but may be required if using match/sigh
    )
  end

  lane :deployToTestFlight do
    ENV['FASTLANE_SESSION']='---\n- !ruby/object:HTTP::Cookie\n  name: myacinfo\n  value: DAWTKNV323952cf8084a204fb20ab2508441a07d02d38d1e625bd3bbb11b5b8f95bd6b2c8a349113da1378e26f32509ceab95b7a7f10880685a88af0190d8dbc7e8b84be4f9ef6484560dd177a6946ca6c6f9700b2dc819628e9574cf3e1234cc8842e583446934709d54a2bbf38a2b0f236adbf76f167fd6fb98e485cab26cc377c2b5160a7ff8a5bbf6703899d3bb1fa446ca0fd712ab3fb7d1c96b509979d289a52d104516136d9bc0972c4f3f040c7f2433381000abecb162464678b00f94a3c0eec1f72c9a7c1734ca37dbb717e53e548076ca72773f1058dbbb8ee43cdebd0ee9f8d6004c4c1cea3d2fe4ffeba35c54ad11aa98e598f021ef32429ef28ab90a68d457387823b68381406bb9f9158034898310b8613819cf7efc5ba78f79ac8564201bee5e08ccea83d5732b5150238b7c01b90c85c06b221778739ea5203eda2c4b262e3ab1c88b4ab187e93a361fdfc2a06ff4d2ff6084ebf918c88822b0275d3fcd30d699737520dc793a681529137fff76e263fc9a2d99b141fd6d114a214c6379dc5cf33b6bf438d3e2e71d6a77288415b43c61389611eb3a38a7bff7708b4fc483cb28172c29993349bb471a2f0cd459a80309f9209013061529a1aac7b5dbcd64b4af6e32ea6b34b13cd72e38d9dab246856f81774f47708e678c6d54473fbbeac53cc6f9bdeb08dbfa14e4080922f622ee9212cf9ba016d0f78fa0de9b43e17d0e7b7a82e71c793447c0e6ec521c91a585a47V3\n  domain: apple.com\n  for_domain: true\n  path: "/"\n  secure: true\n  httponly: true\n  expires:\n  max_age:\n  created_at: 2023-10-03 23:25:25.156661000 +05:00\n  accessed_at: 2023-10-03 23:25:25.158059000 +05:00\n- !ruby/object:HTTP::Cookie\n  name: DES54f4569f652c4e652e4350a154ed2ed6f\n  value: HSARMTKNSRVXWFlattMHRVOBq7WjU83yVGNit0/Q9G/jRuBEtPpwEUY2tGT/2WT9/n1agL7U1n/rjXZ4qYW4N/mxezYbpdzrULMjnLABOEpv7K9Hj5mQpCICa43hczP1w2QW8inq931qIGNp4AVIFszDq1EF0OiUM69f1FiA3B3vB4wekPRikqnhi/xR6zZEtolsPIUQALTHZGLtFtwxV0Ye6pSSmGQ+x4o3m94+iCM=SRVX\n  domain: idmsa.apple.com\n  for_domain: true\n  path: "/"\n  secure: true\n  httponly: true\n  expires:\n  max_age: 2592000\n  created_at: 2023-09-28 19:32:32.682038000 +05:00\n  accessed_at: 2023-10-03 23:25:23.578352000 +05:00\n- !ruby/object:HTTP::Cookie\n  name: dqsid\n  value: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2OTYzNTc1MjYsImp0aSI6IkdQR19Sb3hNdjVyQmxpajhZT0hSemcifQ.zKxylVHtDWo35s9MhGKU4iepTZR2UhR4uAz9b8qJQEM\n  domain: appstoreconnect.apple.com\n  for_domain: false\n  path: "/"\n  secure: true\n  httponly: true\n  expires:\n  max_age: 1800\n  created_at: &1 2023-10-03 23:25:26.687593000 +05:00\n  accessed_at: *1\n'
    sh "fastlane match appstore -a com.heyflutter.asanYab"
    common_build_actions
    api_key = generate_api_key
    upload_to_testflight(api_key: api_key,)
  end

  lane :deployToAppStore do
    common_build_actions
    api_key = generate_api_key
    upload_to_app_store(
      api_key: api_key,
      force: true,
      run_precheck_before_submit: false
    )
  end
end
