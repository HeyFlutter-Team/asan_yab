default_platform(:ios)

platform :ios do
  
  def generate_api_key
    app_store_connect_api_key(
      key_id: "C8A4PUXG5G",
      issuer_id: "7ca7cab7-f3fd-4fb6-a1ed-5fe1a20c2db0",
      key_filepath: "./AuthKey_C8A4PUXG5G.p8",
      duration: 1200,
      in_house: false 
    )
  end

  def common_build_actions

    setup_ci(force: true)

    sync_code_signing(  
      type: "appstore",
      readonly: is_ci
    )

    update_code_signing_settings(
      use_automatic_signing: false,
    )
    unlock_keychain(
      path: "/Users/runner/Library/Keychains/login.keychain",
      password: "2762"
    )

    match(
        type: "appstore",
        readonly: is_ci,
        keychain_name: 'login.keychain',
        keychain_password: '2762',
    )

    api_key = generate_api_key

    curr_build_number = app_store_build_number(
      live: false,
      api_key: api_key,
      app_identifier: "com.heyflutter.asanYab",
      username: "dev.milkejohannes@gmail.com"
    )

    increment_build_number(
      build_number: curr_build_number + 1,
    )

    build_app(
      scheme: "Runner",
      workspace: "Runner.xcworkspace",
      export_method: "app-store",
      export_options: {
        "tree_shake_icons": false,
        provisioningProfiles: {
            "com.heyflutter.asanYab" => "match AppStore com.heyflutter.asanYab 1708429553"
          }
      }
    )
  end

  lane :deployToTestFlight do
    common_build_actions
    api_key = generate_api_key
    upload_to_testflight(api_key: api_key)
  end

  lane :deployToAppStore do
    common_build_actions
    api_key = generate_api_key
    upload_to_app_store(
      api_key: api_key,
      force: true,
      run_precheck_before_submit: false
    )
  end
end
